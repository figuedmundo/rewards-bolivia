FROM node:24-alpine

# Install pnpm
RUN npm install -g pnpm

# Set CI environment variable for pnpm
ENV CI=true

WORKDIR /usr/src/app

# Copy the entire project context
COPY . .

# Install all dependencies. This will create the correct symlinks within the container.
RUN pnpm install --frozen-lockfile

# Build workspace packages that are dependencies
RUN pnpm --filter @rewards-bolivia/logger build
RUN pnpm --filter @rewards-bolivia/shared-types build

# --- Switch to API workspace ---
WORKDIR /usr/src/app/packages/api

COPY packages/api/entrypoint.sh .
RUN chmod +x entrypoint.sh

EXPOSE 3001
CMD ["./entrypoint.sh"]
